<!DOCTYPE html>
<html>
  <head>
    <title>simple git-trainer</title>
    <link rel="stylesheet" href="index.css">
  </head>
  <body>
    <input id="commandline" class="commandLine" spellcheck="false" autofocus="true" />
    <a id="repoDown" href="#">Download Repository</a>
    <div class="demo"></div>

    <script src="libs/jquery-2.0.0.min.js"></script>
    <script src="libs/underscore-min.js"></script>
    <script src="libs/d3.min.js"></script>
    <script src="libs/sha1.js"></script>
    <script src="libs/zip/zip.js"></script>
    <script src="libs/zip/zip-fs.js"></script>
    <script>
        zip.workerScriptsPath = "./libs/zip/";
    </script>
    <script src="libs/zip/deflate.js"></script>

    <script src="src/objects.js"></script>
    <script src="src/repo.js"></script>
    <script src="src/graph.js"></script>
    <script src="src/command-line.js"></script>
    <script src="src/git-commander.js"></script>

    <script>
        var myRepo = new Repo(),
            myGraph = new Graph('.demo', window.innerWidth, window.innerHeight-100),
            commanline = new CommandLine('#commandline');
            myCommander = new gitCommander(myRepo);


        $('body').bind('command-entered', function(e) {
            myCommander.run(commanline.getCurrent());
            myGraph.dataUpdate(myRepo.getData());
        });


        $(document).on('dblclick', '.node', function(e) {
            $('#commandline').val($('#commandline').val()+$(e.target).attr('data-oid').substr(0, 7));
            $('#commandline').focus();
        });

        $('#repoDown').click(function(e){
            var downloadLink = this;
            // TODO переделать (на две ссылки?)
            if(!downloadLink.download) {
                myRepo.save(function(blob){
                    var url = URL.createObjectURL(blob);
                    var clickEvent = document.createEvent("MouseEvent");
                    clickEvent.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
                    downloadLink.href = url;
                    downloadLink.download = "git-repo.zip";
                    downloadLink.dispatchEvent(clickEvent);

                    // Cleanup...
                    setTimeout(function(){
                        URL.revokeObjectURL(url);
                        downloadLink.download = '';
                    }, 5000);
                });
                e.preventDefault();
                return false;
            }
        })
    </script>
  </body>
</html>
